(()=>{"use strict";(e=>{const t=Error("undefined");function r(e,r="",n=""){const a=document.createElement(e);if(a)return r&&(a.innerText=r),n&&a.classList.add(n),a;throw t}function n(e){const t=document.createElement("textarea");t.textContent=e;const r=document.getElementsByTagName("body")[0];r.appendChild(t),t.select();const n=document.execCommand("copy");return r.removeChild(t),n}class a{constructor(e){this.timeline_parsed=e,this.i_loading=0}get now_val(){return this.timeline_parsed[this.i_loading]}set now_val(e){throw Error("now_valにはセットできません")}get now_val_type(){return this.now_val.type}set now_val_type(e){throw Error("now_valにはセットできません")}Normalize(){let e,t=[];const r=this,n=()=>this.timeline_parsed[e].type;for(e=0;e<this.timeline_parsed.length;e++)"bracketL"===n()&&a(),t.push(this.timeline_parsed[e]);function a(){let i=[e];for(t.push(r.timeline_parsed[e]),e++;e<r.timeline_parsed.length;e++){if(e+1===r.timeline_parsed.length&&(r.i_loading=(null==i?void 0:i[1])||i[0],r.error_unexpectedToken("]が不足しています")),"bracketL"===n())i.push(e),a();else{if("new_line"===n())continue;if("bracketR"===n()){i.pop();break}}t.push(r.timeline_parsed[e])}}for(let e=0,r=!0;e<t.length;e++)"new_line"===t[e].type?(r&&(t.splice(e,1),e--),r=!0):r=!1;for(let e=t.length-1;e>=0&&"new_line"===t[e].type;e--)t.pop();this.timeline_parsed=t}parse(){this.Normalize();let e=[];if(0===this.timeline_parsed.length)return e;for(this.timeline_parsed.push({type:"new_line",value:"\n"}),this.i_loading=0;this.i_loading<this.timeline_parsed.length;this.i_loading++){const t=this.loadStatement();e.push(t),"new_line"!==this.now_val_type&&this.error_unexpectedToken("]のあとにコメント以外の文を書くことはできません")}return e}loadStatement(){let e=[];this.checkIsWord();const t=this.now_val.value;this.nextVal();const r=()=>{e.push(this.now_val.value),this.nextVal()};if("move_list"===t||"mv_ls"===t){this.checkIsWord();const r=this.now_val.value;this.nextVal(),"bracketL"!==this.now_val_type&&this.error_unexpectedToken("move_listの第二引数は [ から始まる必要があります"),this.nextVal();const n=[];if("bracketR"!==this.now_val_type)e:for(;;){let e;switch(this.now_val_type){case"bracketL":this.nextVal(),e=this.getMoveListInList("bracketR"),n.push({mode:"switch",value:e});break;case"angle_bracketL":this.nextVal(),e=this.getMoveListInList("angle_bracketR"),n.push({mode:"order",value:e});break;case"braceL":this.nextVal(),e=this.getMoveListInList("braceR"),n.push({mode:"command",value:e});break;case"word":const t={mode:"action",value:[]};t.value.push(this.now_val.value),n.push(t),this.nextVal();break;default:this.error_unexpectedToken("move_list内のパースエラー　正しい値が入力されているか確認してください")}if("bracketR"===this.now_val_type)break e;"commma"===this.now_val_type?this.nextVal():this.error_unexpectedToken("コンマかmove_list終了の]が不足しています")}e=[t,r,n],this.nextVal()}else for(e=[t];;)if("word"===this.now_val_type)r();else{if("new_line"===this.now_val_type)break;this.error_unexpectedToken("この文字は入力できません")}return e}isLastValue(){return this.i_loading+1>=this.timeline_parsed.length}getMoveListInList(e){let t=[];if(this.now_val_type===e)return t;e:for(;;){switch(this.now_val_type){case"word":t.push(this.now_val.value),this.nextVal();break;default:this.error_unexpectedToken("move_list内のかっこが閉じれていないか引数が不正です")}switch(this.now_val_type){case e:this.nextVal();break e;case"commma":this.nextVal();break;default:this.error_unexpectedToken("move_list内のかっこが閉じれていないか引数が不正、もしくはコンマが不足しています")}}return t}nextVal(){this.isLastValue()&&this.error_unexpectedToken("内部エラーの可能性があります。このメッセージが出たらお知らせお願いします。"),this.i_loading++}nextVal_noerror(){this.isLastValue()||this.i_loading++}checkIsWord(){"word"!==this.now_val_type&&this.error_unexpectedToken()}checkIsCommma(){"commma"!==this.now_val_type&&this.error_unexpectedToken()}error_unexpectedToken(e=""){const t=r("span");if(t.appendChild(r("span","→→"+this.now_val.value+"←←","errMsg")),"new_line"!==this.now_val.type)for(let e=this.i_loading+1;e<this.timeline_parsed.length&&"new_line"!==this.timeline_parsed[e].type;e++)t.insertAdjacentText("beforeend",this.timeline_parsed[e].value);for(let e=this.i_loading-1;e>=0&&"new_line"!==this.timeline_parsed[e].type;e--)t.insertAdjacentText("afterbegin",this.timeline_parsed[e].value);"reserved"===this.now_val.type&&(e="予約文字です");const n=r("span");throw n.insertAdjacentText("beforeend","想定外の値: 「"+JSON.stringify(this.now_val.value)+"」"),n.appendChild(r("br")),n.appendChild(t),n.appendChild(r("br")),n.insertAdjacentText("beforeend",e),Error(n.outerHTML)}}class i{constructor(e){this.timeline_str=e,this.timeline_parsed=[],this._now_str="",this.i_nowloadstr=0}parse(){return this.timeline_parsed=this.lexicalAnalysis(),this.timeline_parsed}lexicalAnalysis(){let e=this.timeline_str,t=[],r="";e=e.replaceAll(/\\(\n|$)/g,"");const n=(e,t)=>({type:e,value:t});e:for(let i=0;i<e.length;i++){let s=e[i],o=n("",s);const l=e=>{o.type=e};switch(s){case",":l("commma");break;case"\n":l("new_line");break;case" ":case"　":case"\t":a();continue;case"#":for(;i<e.length;i++)if("\n"===e[i]){i--;continue e}continue;case"{":l("braceL");break;case"}":l("braceR");break;case"[":l("bracketL");break;case"]":l("bracketR");break;case"<":l("angle_bracketL");break;case">":l("angle_bracketR");break;case"(":case"(":case")":case'"':case"'":case"!":case"$":case"%":case"&":case"=":case"^":case"~":case"*":case"?":case";":case"`":l("reserved");break;default:r+=s;continue e}a(),t.push(o)}function a(){0!==r.length&&(t.push(n("word",r)),r="")}return a(),t}}const s=new class{constructor(e=location.href,t=!0){this._href=e,this._urlAPI=new URL(this._href),this.autochange=t}getParam(e){return decodeURIComponent(this._urlAPI.searchParams.get(e)||"")}setParam(e,t=""){this._urlAPI.searchParams.set(e,encodeURIComponent(t)),this.autochange&&this._setURL(this._urlAPI.href)}get hash(){return this._urlAPI.hash}set hash(e){this._setURL(`#${e}`)}get href(){return this._urlAPI.protocol+"//"+this._urlAPI.host+this._urlAPI.pathname+"?TL="+encodeURIComponent(this.getParam("TL"))}set href(e){this._urlAPI.href=e}_setURL(e){this.autochange&&history.replaceState("","",e)}_reflesh(){this._urlAPI=new URL(this._href)}}(void 0,!1);class o{constructor(){this.current=new Array,this.switchData=new Array,this.cardData=new Array,this.comment=new Array,this.color=void 0,this.place_of_currentTimeline=0}move(e,t=this.ID_of_firstChara(),r=!1){if(this.setColor(t,this.place_of_currentTimeline),t!==this.ID_of_firstChara()&&!1===r)throw new Error("最初のキャラ以外は操作できません");const n=this.get_chara_by_ID(t).timeline_OrderValue;let a=n+e-(n-this.OrderValue_of_firstChara());this.pushChara(t,a),this.nextturn()}setColor(e,t){this.color&&(this.comment.push(["color",e,t,this.color]),this.color=void 0)}setChara(e,t){this.pushChara(e,t)}place_to_moved(e){let t,r=-1;for(let t=this.current.length-1;t>this.place_of_currentTimeline;t--)if(e>=this.current[t].timeline_OrderValue){r=t;break}return t=-1===r?this.place_of_currentTimeline+1:r+1,t}pushChara(e,t){let r;try{n=this.get_chara_by_ID(e),r=JSON.parse(JSON.stringify(n))}catch(t){r={id:e}}var n;r.timeline_OrderValue=t;let a=this.place_to_moved(t);this.current.splice(a,0,r)}addChara(e,t){let r={id:e,timeline_OrderValue:t,type:"chara"};this.current.splice(this.place_of_currentTimeline,0,r)}addSkillCard(e,t,r){let n,a=!0;try{n=this.get_chara_by_ID(e)}catch(e){a=!1}if(a){if(!n)throw Error("ここは実行されないはず");if("skillcard"!==n.type)throw Error("指定された名前はスキルカードではありません");n.time=r,this.current[this.placeToChara(e)]=n}else{let n=this.OrderValue_of_firstChara()+t,a=this.place_to_moved(n);this.current.splice(a,0,{type:"skillcard",time:r,id:e,timeline_OrderValue:n,OrderValue:t}),this.cardData.push([this.place_of_currentTimeline,e])}}switchChara(e,t){this.switchData.push([this.place_of_currentTimeline,e,t]),this.setColor(e,this.place_of_currentTimeline),e===this.ID_of_firstChara()?(this.current[this.placeToChara(e)].id=t,this.current[this.placeToChara(t)].timeline_OrderValue=this.OrderValue_of_firstChara()):this.switchSupportChara(e,t)}switchSupportChara(e,t){this.current.splice(this.placeToChara(e),1),this.addChara(t,this.OrderValue_of_firstChara())}inited(){this.current.sort((function(e,t){const r=e.timeline_OrderValue,n=t.timeline_OrderValue;return r<n?-1:r>n?1:0})),this.place_of_currentTimeline=0}get firstChara(){return this.current[this.place_of_currentTimeline]}set firstChara(e){throw Error("firstCharaにはセットできません")}OrderValue_of_firstChara(){return this.firstChara.timeline_OrderValue}ID_of_firstChara(){return this.firstChara.id}nextturn(){var e;if(this.place_of_currentTimeline++,"skillcard"===(null===(e=this.firstChara)||void 0===e?void 0:e.type))if(this.firstChara.time--,0===this.firstChara.time)this.nextturn();else{if(this.firstChara.time<0)throw Error("skillcardのtimeに0未満の数値");this.move(this.firstChara.OrderValue,this.ID_of_firstChara(),!1)}}get_chara_by_ID(e){return this.current[this.placeToChara(e)]}placeToChara(e){for(let t=this.place_of_currentTimeline;t<this.current.length;t++)if(this.current[t].id===e)return t;throw Error("Not Found!IDに誤りがあります")}}class l{constructor(e,t,r,n=0){this.id=e,this.SPD=t,this.SPD_buff=r,this.LoadFactorReduce=n}calculateOrderValue(e,t=0){const r=this.SPD,n=this.SPD_buff/100;let a=Math.min(Math.max(124-Math.floor(r/2),0),100),i=Math.floor(a*(e/100)*(1-t)*(1-n));return Math.max(Math.min(i,500),15)}initOrderValue(){return this.calculateOrderValue(100,0)}}let c,h;function d(){var e,n,d,u;const _=document.getElementById("input_txt");let p;if(!_)throw t;p=_.value,s.setParam("TL",p),h={main:[],set:[]};let f={},w=new o,v={};const b=document.getElementById("error"),g=document.getElementById("info");if(!b||!g)throw t;let k;b.innerHTML="",g.innerHTML="";try{const e=new i(p).parse();k=new a(e).parse()}catch(e){throw b.innerHTML=e,e}const y="init",C="start",x="start_sort",E="waiting_mode";let T=y;for(let a=0;a<k.length;a++)try{const r=null===(e=k[a])||void 0===e?void 0:e[0],i=null===(n=k[a])||void 0===n?void 0:n[1],s=null===(d=k[a])||void 0===d?void 0:d[2],o=null===(u=k[a])||void 0===u?void 0:u[3];let c,_,m,p,b,L,V,O;switch(T){case y:switch(r){case"set":c=i.toString(),_=Number(s),m=Number(o)||0,f[c]=new l(c,_,m),w.setChara(c,f[c].initOrderValue()),0===h.set.length?h.set=[k[a]]:h.set.push(k[a]);break;case"start":T=C,w.inited();break;case"start_sort":T=x,w.inited();break;case"":break;default:throw Error("need 'start'")}break;case C:var I=k[a];if("mv_ls"===I[0]||"move_list"===I[0])throw Error("start_sort ~ end_sort内にmove_listを書いてください");S(...I);break;case x:switch(r){case"move_list":case"mv_ls":c=i,b=s,v[c]=b;break;case"end_sort":A(),T=E;break;case"":break;default:throw Error("no command found:「"+r+"」")}break;case E:switch(r){case"start":T=C;break;case"start_sort":T=x;break;case"":break;default:throw Error("need 'start'")}break;default:throw Error("内部エラー")}function A(){for(var e;;){const r=w.ID_of_firstChara();if(void 0===(null===(e=v[r])||void 0===e?void 0:e[0])){let e={};if(Object.keys(v).forEach((function(t){0!==v[t].length&&(e[t]=v[t])})),0!==Object.keys(e).length){if(!g)throw t;g.insertAdjacentText("beforeend","ⓘinfo :move_listに使われていないスキルがあります:"+JSON.stringify(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,t.map((e=>(1===e.value.length&&(e.value=e.value[0]),e.value)))])))).replaceAll('"',""))}break}const n=v[r].shift();if(!n)throw Error("内部エラーの可能性があります。このメッセージが出たらお知らせお願いします。");try{if("order"===n.mode){const[e]=n.value,t=e.match(/^[a-zA-Z]/g),a=e.match(/\d+/g);if(t&&S("color",t[0]),!a)throw Error("硬直が見つかりませんでした");S("order",r,a[0])}else if("action"===n.mode){const[e]=n.value,t=e.match(/^[a-zA-Z]/g),a=e.match(/\d+/g);if(t&&S("color",t[0]),!a)throw Error("硬直値が見つかりませんでした");S("action",r,a[0])}else if("switch"===n.mode){const[e,t,a]=n.value;S("switch",r,e,t,a||"0"),v[e]=v[r],v[r]=[]}else{if("command"!==n.mode)throw Error("テキストのパースエラー");S(...n.value)}}catch(e){throw Error(e+":  "+JSON.stringify(n.value)+" ")}}}function S(...e){const[t,r,n,a,i]=e;let s,o;switch(""!==t&&"end"!==t&&(0===h.main.length?h.main=[e.filter((e=>e||"0"===e))]:h.main.push(e.filter((e=>e||"0"===e)))),t){case"buffset":case"b":s=r,o=Number(n)||0,f[s].SPD_buff=o;break;case"buffadd":case"b+":s=r,o=Number(n)||0,f[s].SPD_buff+=o;break;case"buffminus":case"b-":s=r,o=Number(n)||0,f[s].SPD_buff-=o;break;case"add":case"a":s=r,_=Number(n),o=Number(a)||0,f[s]=new l(s,_,o),w.addChara(s,f[s].initOrderValue());break;case"move":case"m":p=Number(r),s=n;const e="true"===a;w.move(f[w.ID_of_firstChara()].calculateOrderValue(p),s,e);break;case"action":case"ac":s=r,p=Number(n);const t="true"===a;w.move(f[w.ID_of_firstChara()].calculateOrderValue(p),s,t);break;case"order":s=r,O=Number(n),w.move(O,s,!1);break;case"switch":case"sw":L=r,V=n,_=Number(a),o=Number(i)||0,w.switchChara(L,V),f[V]=new l(V,_,o);break;case"color":case"c":var c=r;w.color=c;break;case"skillcard":case"sc":var d=r,u=Number(n);p=Number(a);var m=Number(i),v=new l(d,u,0);f[d]=v,w.addSkillCard(d,v.calculateOrderValue(p),m);break;case"end":T=E;break;case"":break;default:throw Error("no command found")}}}catch(e){b.appendChild(r("br")),b.insertAdjacentText("beforeend",e);break}let L=[];for(let e in f)L.push(e);let V=Array.from(new Array(Object.keys(f).length),(()=>new Array(w.current.length).fill(void 0)));w.current.forEach(((e,t)=>{let r=e.id,n=e.timeline_OrderValue,a=L.indexOf(r);V[a][t]=n})),w.switchData.forEach((e=>{const[t,r,n]=e;let a=L.indexOf(r),i="";i=a<L.indexOf(n)?"↓↓":"↑↑",V[a][t]=i})),w.cardData.forEach((e=>{let t=L.indexOf(e[1]);V[t][e[0]]="→"}));const O=w.place_of_currentTimeline+1,A=document.getElementById("firstchara");A&&(A.innerText=w.ID_of_firstChara());const S=document.getElementById("now_place");S&&(S.innerText=String(O)),c=[V,L],function(e,n,a,i){let s=r("thead"),o=r("tr");for(let t=0;t<=e[0].length;t++){let e;e=t===i?r("th",t.toString(),"now_place"):0===t?r("th","","nowrap"):r("th",t.toString()),o.appendChild(e)}s.appendChild(o);for(let t=0;t<e.length;t++){let i=r("tr");i.appendChild(r("td",n[t],"nowrap"));for(let s=0;s<e[0].length;s++){let o;const l=a.find((e=>"color"===e[0]&&e[1]===n[t]&&e[2]===s));let c,h=e[t][s];c="string"==typeof h?h:"number"==typeof h?String(h):"",o=l?r("td",c,"color-"+l[3]):r("td",c),i.appendChild(o)}s.appendChild(i)}const l=document.querySelector("table");if(!l)throw t;l.innerHTML="",l.appendChild(s)}(V,L,w.comment,O),m()}function u(){const[e,t]=c;let r="";for(let t=0;t<e[0].length;t++)r+=","+(t+1);r+="\n";for(let n=0;n<e.length;n++){r+=t[n];for(let t=0;t<e[0].length;t++)r+=",",r+=e[n][t]||"";r+="\n"}!function(e,t="timeline.csv"){let r=new Uint8Array([239,187,191]),n=new Blob([r,e],{type:"text/csv"}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download=t,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}(r)}function _(){n(s.href);const e=document.getElementById("copyed");if(!e)throw t;e.style.display="block",setTimeout((()=>{e.style.display="none"}),1e3)}function m(){const e=document.getElementById("popup");if(!e)throw t;e.innerText=f()}function p(){n(f());const e=document.getElementById("copyed_popup");if(!e)throw t;e.style.display="block",setTimeout((()=>{e.style.display="none"}),1e3)}function f(){return h.set.map((e=>e.join(" "))).join("\n")+"\n\nstart\n"+h.main.map((e=>"  "+e.join(" "))).join("\n")+"\nend"}e.onload=()=>{const r=document.getElementById("input_txt");if(!r)throw t;const a=s.getParam("TL");null!==typeof a&&(r.textContent=a),r.oninput=d;const i=document.getElementById("csvDownload");i&&(i.onclick=u);const o=document.getElementById("copyTL");o&&(o.onclick=_);const l=document.getElementById("log_convertedTL");l&&(l.onclick=m);const c=document.getElementById("copy_ConvertedTL");c&&(c.onclick=p);const h=document.getElementById("jumpTwitter");h&&(h.onclick=()=>{e.open("https://twitter.com/Y52en/status/1402239605978517505?s=20","_blank")});const f=document.getElementById("unzipMoveList");f&&(f.onclick=()=>{const e=document.getElementById("pop11");e&&(e.checked=!0)});const w=document.getElementById("isSet_onbeforeunload");if(!w)throw t;e.onbeforeunload=function(e){0!==r.value.length&&w.checked&&(e.preventDefault(),e.returnValue="ページから離れますか？")},r.addEventListener("keydown",(e=>{if("c"===e.key&&e.ctrlKey){let e=r.selectionStart;if(e===r.selectionEnd){let t=r.value;const a="^(.*\\n){"+[...t.slice(0,e).matchAll(/\n/g)].length+"}";return n(t.replace(new RegExp(a+"(.*)($|[\\s\\S]*$)"),"$2")),!1}}return!0})),r.addEventListener("keydown",(e=>{if("/"===e.key&&e.ctrlKey){let e=r.selectionStart,t=r.selectionEnd,n=r.value;const a=[...n.slice(0,e).matchAll(/\n/g)].length,i=[...n.slice(0,t).matchAll(/\n/g)].length;for(let r=a;r<=i;r++){const i="^(.*\n){"+r+"}";new RegExp(i+"( )*#").test(n)?(n=n.replace(new RegExp("("+i+"( )*)#"),"$1"),r===a&&e--,t--):(n=n.replace(new RegExp("("+i+")"),"$1#"),r===a&&e++,t++)}r.value=n,r.setSelectionRange(e,t),d()}})),r.addEventListener("keydown",(e=>{if(("["===e.key||"]"===e.key)&&e.ctrlKey){let t=r.selectionStart,n=r.selectionEnd,a=r.value;const i=[...a.slice(0,t).matchAll(/\n/g)].length,s=[...a.slice(0,n).matchAll(/\n/g)].length;for(let r=i;r<=s;r++){const s="^(.*\n){"+r+"}",o=a;"["===e.key?(a=a.replace(new RegExp("("+s+") "),"$1"),o!==a&&(r===i&&t--,n--)):(a=a.replace(new RegExp("("+s+")"),"$1 "),o!==a&&(r===i&&t++,n++))}r.value=a,r.setSelectionRange(t,n),d()}})),d()}})(window)})();